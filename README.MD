
# üìÑ Script de Importa√ß√£o de Planilha para Banco de Dados (Vers√£o Final)

## üéØ Objetivo
Este script automatiza a **importa√ß√£o de textos gerados pela IA** a partir de uma planilha Excel, inserindo-os diretamente no **SQL Server** nas tabelas:

- `PUB_TIPOS_TEXTOS`
- `PUB_TIPOS_TEXTOS_TITULOS`

Possui suporte para **modo de teste** com SQLite e **modo de produ√ß√£o** com SQL Server via `pyodbc`.

---

## üõ†Ô∏è Fluxo Geral

1. **Leitura da planilha**.
2. **Modelagem dos dados** no formato correto das tabelas do banco.
3. **Conex√£o ao banco**:
   - TESTE ‚Üí SQLite.
   - PRODU√á√ÉO ‚Üí SQL Server.
4. **Inser√ß√£o dos dados**:
   - TESTE ‚Üí Inser√ß√£o simples.
   - PRODU√á√ÉO ‚Üí UPSERT com `MERGE`.
5. **Valida√ß√£o** (TESTE).
6. **Registro em log** de todas as a√ß√µes e erros.

---

## üìÇ Estrutura da Planilha

| id_tipo | Texto Principal | Texto Secund√°rio | Texto Title (opcional) | Texto Meta Description (opcional) |
|---------|----------------|------------------|------------------------|------------------------------------|
| 79      | Conte√∫do HTML  | Conte√∫do HTML    | T√≠tulo opcional        | Meta description opcional         |
| 81      | Conte√∫do HTML  | Conte√∫do HTML    | ...                    | ...                                |

---

## üóÑÔ∏è Estrutura das Tabelas no Banco

### **Tabela 1 ‚Äì `PUB_TIPOS_TEXTOS`**
| Coluna         | Origem na planilha | Observa√ß√£o |
|----------------|-------------------|------------|
| idTipo         | id_tipo           | Identificador √∫nico |
| TextoPrimario  | Texto Principal   | Texto HTML |
| TextoSecundario| Texto Secund√°rio  | Texto HTML |
| Ativo          | Valor fixo = 1    | Sempre ativo |
| IdConteudo     | NULL              | Sem dados |
| Header         | NULL              | Sem dados |

### **Tabela 2 ‚Äì `PUB_TIPOS_TEXTOS_TITULOS`**
| Coluna               | Origem | Observa√ß√£o |
|----------------------|--------|------------|
| idTipo               | id_tipo| Identificador √∫nico |
| TextoTitle           | Texto Title (se existir) | Pode ser preenchido futuramente |
| TextoMetaDescription | Texto Meta Description (se existir) | Pode ser preenchido futuramente |
| Ativo                | 1      | Sempre ativo |
| IdConteudo           | NULL   | Sem dados |

---

## ‚öôÔ∏è Como Funciona

### **1Ô∏è‚É£ Leitura da Planilha**
Utiliza `pandas.read_excel()` para carregar os dados da aba `"Planilha1"`.

### **2Ô∏è‚É£ Modelagem dos Dados**
Cria dois DataFrames (`df_tipos_textos` e `df_tipos_titulos`) com as colunas no formato exato das tabelas.

### **3Ô∏è‚É£ Conex√£o ao Banco**
- **TESTE** ‚Üí SQLite em mem√≥ria (`sqlite3.connect(":memory:")`).
- **PRODU√á√ÉO** ‚Üí SQL Server (`pyodbc.connect(...)`).

### **4Ô∏è‚É£ Inser√ß√£o dos Dados**
- **TESTE** ‚Üí Inser√ß√£o simples (`INSERT`).
- **PRODU√á√ÉO** ‚Üí UPSERT com `MERGE` (atualiza se existir, insere se n√£o existir).

### **5Ô∏è‚É£ Valida√ß√£o**
No modo TESTE, executa consultas `SELECT` para verificar se os dados foram gravados.

### **6Ô∏è‚É£ Registro em Log**
Todos os eventos s√£o gravados no arquivo `importacao.log`:
- Quantidade de registros processados.
- Erros de inser√ß√£o.
- Conclus√£o.

---

## üöÄ Como Usar

1. Instale as depend√™ncias:
```bash
pip install pandas openpyxl pyodbc
```

2. Configure o arquivo Python:
```python
MODO = "TESTE"  # ou "PRODUCAO"
```

3. No modo produ√ß√£o, configure a conex√£o com o SQL Server:
```python
conn = pyodbc.connect(
    'DRIVER={ODBC Driver 17 for SQL Server};'
    'SERVER=SEU_SERVIDOR;'
    'DATABASE=SEU_DATABASE;'
    'UID=SEU_USUARIO;'
    'PWD=SUA_SENHA;'
)
```

4. Execute o script:
```bash
python AutomacaoBanco.py
```

5. Confira o log no arquivo `importacao.log`.

---


```bash
No SQL SERVER:

   1- Checagem r√°pida pra ver se as tabelas existem.

      SELECT TOP 1 * FROM PMP.dbo.PUB_TIPOS_TEXTOS;
      SELECT TOP 1 * FROM PMP.dbo.PUB_TIPOS_TEXTOS_TITULOS;

      -- Mapeamento para derivar id_tipo (se necess√°rio)
      SELECT TOP 5 * FROM PMP.dbo.PROCESSADO_BUSCA_TIPOS;

      -- Mapa idTipo -> IdConteudo (para seed)
      SELECT TOP 5 * FROM PMP.dbo.TEMATICOS_CONTEUDO_ITEM;

   2- Update Sem o SEED:
"""
O que acontece:

O script filtra os id_tipo da planilha que j√° existem em PMP.dbo.PUB_TIPOS_TEXTOS.

Ele atualiza:

TextoPrimario, TextoSecundario, Ativo=1 em PUB_TIPOS_TEXTOS.

(se vierem) TextoTitle, TextoMetaDescription, Ativo=1 em PUB_TIPOS_TEXTOS_TITULOS.

Para id_tipo que n√£o existem no PMP, nada √© atualizado (rowcount=0).

Se a propor√ß√£o de id_tipo inexistentes passar do limite (--abort-if-missing-ratio, default 35%), ele aborta para evitar ‚Äúrodada fantasma‚Äù.
```