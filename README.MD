# üìÑ Automa√ß√£o: N8N + Google Drive + Watcher + SQL Server

## üéØ Objetivo
- Gerar uma planilha **.xlsx** no N8N (ap√≥s os agentes de IA), enviar ao **Google Drive** e
- Ter um **watcher** (script Python) que detecta o novo arquivo, baixa e executa o **AutomacaoBanco.py** para atualizar o **SQL Server**.
- Organizar arquivos em **/Processados** e **/Falha** e registrar logs.

---

## üß≠ Vis√£o geral do fluxo
1) **N8N**: l√™ Sheets ‚Üí passa por 2 agentes de IA ‚Üí **Spreadsheet File** cria XLSX ‚Üí **Google Drive (Upload)** envia para **/Entrada**.  
2) **Watcher (`watch_run.py`)**: monitora a pasta do Drive; quando acha um XLSX novo/atualizado:
   - Baixa para pasta tempor√°ria e **sanitiza o nome** (sem ‚Äú:‚Äù e quebras de linha).
   - Executa `AutomacaoBanco.py` com os par√¢metros definidos.
   - Se rodar OK ‚Üí registra em `processados.json` e (opcional) **move no Drive para /Processados**.  
     Se falhar ‚Üí (opcional) **move para /Falha**.
3) **AutomacaoBanco.py**: l√™ o XLSX e atualiza:
   - `PMP.dbo.PUB_TIPOS_TEXTOS` (TextoPrimario, TextoSecundario, Ativo=1)  
   - `PMP.dbo.PUB_TIPOS_TEXTOS_TITULOS` (TextoTitle, TextoMetaDescription, Ativo=1)  
   - Se `--auto-seed`: cria linhas-base quando `idTipo` n√£o existe (com mapeamento `IdConteudo`).

---

## üì¶ Requisitos
- **Python 3.10+** (3.12 OK).
- Pacotes:
  ```bash
  pip install pandas openpyxl pyodbc google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2
  ```
- **ODBC Driver 17** for SQL Server (Windows).

---

## ‚öôÔ∏è Configura√ß√£o do Google (OAuth)
1. No **Google Cloud Console** ‚Üí **APIs & Services** ‚Üí **Library** ‚Üí ative **Google Drive API** (e **Google Sheets API** se precisar).  
2. **Credentials** ‚Üí **Create Credentials** ‚Üí **OAuth client ID** ‚Üí **Desktop app** ‚Üí fa√ßa download do `credentials.json`.  
3. Coloque o `credentials.json` **na mesma pasta do `watch_run.py`**. Na primeira execu√ß√£o, abrir√° o navegador, voc√™ loga e √© criado o `token.json`.

> **Dica:** se trocar de conta, apague `token.json` e rode novamente para refazer o login.

---

## üóÇÔ∏è Pastas no Google Drive
Crie (ou defina) estas pastas e anote os **IDs** (parte ap√≥s `folders/` na URL):
```
/Entrada
/Processados
/Falha
```
Compartilhe a pasta com a conta que voc√™ usar√° no OAuth (ou com a **Service Account**, se usar SA).
No `watch_run.py`, voc√™ pode definir via **vari√°veis de ambiente**:
```
DRIVE_FOLDER_ENTRADA_ID=<id>
DRIVE_FOLDER_PROCESSADOS_ID=<id>
DRIVE_FOLDER_FALHA_ID=<id>
```

---

## üß© N8N ‚Äì configura√ß√£o m√≠nima
- **Spreadsheet File** ‚Üí *Create spreadsheet*  
  - **Binary Property:** `data`  
  - **File Format:** `XLSX`  
  - **Sheet Name:** `Planilha1`  
  - **File Name (Expression):**
    ```
    planilha_final_{{ 
      (d => 
        String(d.getDate()).padStart(2,'0') + '_' +
        String(d.getMonth() + 1).padStart(2,'0') + '_' +
        d.getFullYear() + '_' +
        String(d.getHours()).padStart(2,'0') + '_' +
        String(d.getMinutes()).padStart(2,'0') + '_' +
        String(d.getSeconds()).padStart(2,'0')
      )(new Date()) 
    }}.xlsx
    ```
- **Google Drive ‚Üí Upload**  
  - **Use Binary Data:** `true`  
  - **Binary Property:** `data`  
  - **Parent Folder:** `/Entrada`  
  - (**Opcional**) File Name com a **mesma expression** acima (ou deixe o do Spreadsheet File).

> **Importante:** ative o **modo Expression (fx)** no campo *File Name*; se aparecer literalmente com `{{...}}`, voc√™ est√° em modo texto.

---

## üêç Watcher (`watch_run.py`)
### Par√¢metros principais (no c√≥digo ou por env)
```python
FOLDER_ID = "ID_DA_PASTA_ENTRADA"     # se a listagem usa uma pasta √∫nica
CREDENTIALS_FILE = "credentials.json"
TOKEN_FILE = "token.json"
CHECK_EVERY_SEC = 30
```
**Movimenta√ß√£o opcional** (por env):
```
DRIVE_FOLDER_ENTRADA_ID     = <id>
DRIVE_FOLDER_PROCESSADOS_ID = <id>
DRIVE_FOLDER_FALHA_ID       = <id>
```

### Execu√ß√£o
```bash
python -u watch_run.py
```
- `-u` = logs sem buffer (aparecem na hora).  
- Na 1¬™ vez, abre o navegador para login do Google.  
- Log detalhado tamb√©m √© salvo em **`watcher_debug.log`** (injetado pelo ‚Äúhardmode‚Äù de debug).

### Como funciona internamente
1. Autentica no Drive (usa `credentials.json` + `token.json`).  
2. Lista arquivos .xlsx na pasta definida.  
3. Para cada arquivo, monta uma ‚Äúassinatura‚Äù (`name`, `modifiedTime`, `md5Checksum`) e compara com `processados.json`.  
4. Se for novo/atualizado:
   - Sanitiza o nome (remove caracteres inv√°lidos no Windows, como `:` e quebras de linha).
   - Baixa para um `TemporaryDirectory`.
   - Executa `AutomacaoBanco.py <arquivo baixado>`
   - Se **sucesso**: grava em `processados.json` e (se configurado) move para **/Processados**.  
     Se **falha**: (se configurado) move para **/Falha**.
   
> O watcher **n√£o reprocessa** o mesmo `fileId` com o mesmo `md5Checksum`.

---

## üè¶ AutomacaoBanco.py ‚Äì resumo de uso
### DRY‚ÄëRUN (sem gravar; mostra seeds)
```bash
python AutomacaoBanco.py "C:	mp\planilha.xlsx" --auto-seed --dry-run --max-seed 100 --pick-idconteudo min --map-table TEMATICOS_CONTEUDO_ITEM --tipo-col IDTIPO --conteudo-col ID --default-idconteudo 1
```
### Produ√ß√£o (aplica UPDATEs e SEEDs)
```bash
python AutomacaoBanco.py "C:	mp\planilha.xlsx" --auto-seed --max-seed 100 --pick-idconteudo min --map-table TEMATICOS_CONTEUDO_ITEM --tipo-col IDTIPO --conteudo-col ID --default-idconteudo 1
```
- Preenche `TextoPrimario` / `TextoSecundario` / `Ativo=1` e SEO (quando presentes).  
- Garante `id_tipo` v√°lido (direto da planilha ou derivado de `id_cat/id_grupo` se implementado).  
- Cria base quando o `idTipo` n√£o existe (seed).

---

## üîç Valida√ß√£o no SQL (antes/depois)
```sql
-- Antes (exemplo com IDs da planilha)
SELECT idTipo, TextoPrimario FROM PMP.dbo.PUB_TIPOS_TEXTOS WHERE idTipo IN (101,102,103);
SELECT idTipo, TextoTitle FROM PMP.dbo.PUB_TIPOS_TEXTOS_TITULOS WHERE idTipo IN (101,102,103);

-- Depois
SELECT idTipo, TextoPrimario, TextoSecundario, Ativo
FROM PMP.dbo.PUB_TIPOS_TEXTOS WHERE idTipo IN (101,102,103);

SELECT idTipo, TextoTitle, TextoMetaDescription, Ativo
FROM PMP.dbo.PUB_TIPOS_TEXTOS_TITULOS WHERE idTipo IN (101,102,103);
```

---

## üßØ Troubleshooting
- **Nada aparece no terminal / fecha sozinho** ‚Üí rode com:
  ```bash
  python -u -X dev watch_run.py
  ```
  e consulte `watcher_debug.log` na mesma pasta.  
- **Erro `Credentials.refresh() missing 'request'`** ‚Üí importe e use:
  ```python
  from google.auth.transport.requests import Request
  creds.refresh(Request())
  ```
- **`FileNotFoundError: credentials.json`** ‚Üí coloque o `credentials.json` na pasta do script (ou ajuste o caminho).  
- **`Invalid argument` ao salvar** ‚Üí o nome tem `:`/quebras de linha. Use a sanitiza√ß√£o (o watcher j√° trata).  
- **Token inv√°lido/corrompido** ‚Üí apague `token.json` e rode de novo para refazer o login.  
- **Hor√°rio errado no nome** ‚Üí use express√£o de data **local** no N8N (sem `toISOString()`) como no exemplo acima.

---

## üß≠ Dicas de opera√ß√£o
- Nome de arquivo **com data**: `planilha_final_DD_MM_YYYY_HH_MM_SS.xlsx` (j√° configurado no N8N).  
- Mantenha o watcher rodando em um **terminal dedicado** ou agendado (Windows Task Scheduler).  
- Fa√ßa **backup** da pasta **/Processados** periodicamente.

---

## ‚úÖ Conclus√£o
Com este fluxo, voc√™ consegue:
- Automatizar de ponta a ponta (N8N ‚Üí Drive ‚Üí Watcher ‚Üí SQL).
- Garantir consist√™ncia com seed controlado e logs.
- Organizar a pasta do Drive com **Processados** e **Falha**.
