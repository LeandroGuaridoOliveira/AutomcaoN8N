üìÑ Automa√ß√£o de Importa√ß√£o de Planilhas para SQL Server com Watcher no Google Drive
üéØ Objetivo

Automatizar o processo de:

Receber uma planilha .xlsx gerada pelo fluxo do N8N (j√° com textos processados por IA).

Detectar automaticamente quando o arquivo for salvo no Google Drive.

Executar o script AutomacaoBanco.py para inserir/atualizar os dados no SQL Server.

Registrar logs e organizar arquivos processados.

üõ†Ô∏è Fluxo Geral da Solu√ß√£o
1. Entrada da planilha

O N8N gera a planilha final (.xlsx) com os textos.

A planilha √© enviada automaticamente para uma pasta espec√≠fica do Google Drive.

2. Watcher (watch_run.py)

Fica monitorando a pasta do Drive usando a API do Google.

Quando detecta novo arquivo ou atualiza√ß√£o:

Baixa o arquivo para um diret√≥rio tempor√°rio.

Executa o AutomacaoBanco.py com o arquivo baixado.

Registra no processados.json que o arquivo foi processado (para evitar repeti√ß√£o).

Move o arquivo para a pasta "Processados" ou "Falha" no Drive (opcional).

3. Script AutomacaoBanco.py

L√™ a planilha.

Modela os dados para as tabelas:

PUB_TIPOS_TEXTOS

PUB_TIPOS_TEXTOS_TITULOS

Atualiza os registros existentes e, se necess√°rio, cria novas linhas com seed autom√°tico para id_tipo inexistentes.

Registra logs detalhados.

üìÇ Estrutura Esperada da Planilha
id_tipo	Texto Principal	Texto Secund√°rio	Texto Title	Texto Meta Description
79	HTML	HTML	T√≠tulo	Meta
81	HTML	HTML	...	...
‚öôÔ∏è Como Configurar
1. Pr√©-requisitos

Python 3.10 ou superior

Conta do Google com acesso √† pasta do Drive

Depend√™ncias instaladas:

pip install pandas openpyxl pyodbc google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2

2. Configura√ß√£o do Google API

No Google Cloud Console:

Criar um projeto.

Ativar a Google Drive API.

Criar credenciais OAuth Client ID do tipo "Desktop App".

Baixar o arquivo credentials.json e colocar na mesma pasta do watch_run.py.

Na primeira execu√ß√£o:

O script abrir√° o navegador pedindo login.

Escolha a conta correta e permita o acesso.

Ser√° criado o arquivo token.json para uso futuro (n√£o precisa logar de novo).

3. Configura√ß√£o do Watcher

No watch_run.py:

FOLDER_ID = "ID_DA_PASTA_NO_GOOGLE_DRIVE"
CREDENTIALS_FILE = "credentials.json"
TOKEN_FILE = "token.json"
CHECK_EVERY_SEC = 30  # intervalo de checagem em segundos

4. Configura√ß√£o do AutomacaoBanco.py

Ajustar MODO para "PRODUCAO" ou "TESTE".

Configurar a string de conex√£o do SQL Server no modo produ√ß√£o:

conn = pyodbc.connect(
    'DRIVER={ODBC Driver 17 for SQL Server};'
    'SERVER=SEU_SERVIDOR;'
    'DATABASE=SEU_DATABASE;'
    'UID=SEU_USUARIO;'
    'PWD=SUA_SENHA;'
)

üöÄ Como Usar
1. Rodar o Watcher

No terminal, na pasta do script:

python -u watch_run.py


O -u garante sa√≠da de log em tempo real.

O Watcher ficar√° ativo monitorando a pasta do Google Drive.

Quando detectar novo arquivo .xlsx, ele executa automaticamente o AutomacaoBanco.py.

2. Verificar no Banco

Antes de rodar, veja os id_tipo j√° existentes:

SELECT idTipo, TextoPrimario FROM PMP.dbo.PUB_TIPOS_TEXTOS;
SELECT idTipo, TextoTitle FROM PMP.dbo.PUB_TIPOS_TEXTOS_TITULOS;


Ap√≥s rodar, verifique novamente para confirmar a atualiza√ß√£o:

SELECT idTipo, TextoPrimario, TextoSecundario, IdConteudo FROM PMP.dbo.PUB_TIPOS_TEXTOS;
SELECT idTipo, TextoTitle, TextoMetaDescription, IdConteudo FROM PMP.dbo.PUB_TIPOS_TEXTOS_TITULOS;

3. Organiza√ß√£o de Arquivos no Drive

Processados: arquivos que foram importados com sucesso.

Falha: arquivos que geraram erro na importa√ß√£o.

Essa movimenta√ß√£o √© feita pelo pr√≥prio watch_run.py (se as pastas forem configuradas).

üìå Boas Pr√°ticas

Sempre testar com --dry-run no AutomacaoBanco.py antes de atualizar o banco real.

Garantir que a planilha final gerada pelo N8N esteja no formato correto.

Manter backup da pasta de Processados no Drive.

Atualizar credentials.json se mudar de conta do Google.
